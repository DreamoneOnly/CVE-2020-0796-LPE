#include "stdafx.h"


using _NtQuerySystemInformation = NTSTATUS(__fastcall*)(
	IN ULONG SystemInformationClass,
	OUT PVOID                   SystemInformation,
	IN ULONG                    SystemInformationLength,
	OUT PULONG_PTR              ReturnLength);


typedef struct _SYSTEM_HANDLE_TABLE_ENTRY_INFO_EX {
	PVOID Object;
	ULONG_PTR UniqueProcessId;
	ULONG_PTR HandleValue;
	ULONG GrantedAccess;
	USHORT CreatorBackTraceIndex;
	USHORT ObjectTypeIndex;
	ULONG  HandleAttributes;
	ULONG  Reserved;
} SYSTEM_HANDLE_TABLE_ENTRY_INFO_EX, * PSYSTEM_HANDLE_TABLE_ENTRY_INFO_EX;

typedef struct _SYSTEM_HANDLE_INFORMATION_EX {
	ULONG_PTR NumberOfHandles;
	ULONG_PTR Reserved;
	SYSTEM_HANDLE_TABLE_ENTRY_INFO_EX Handles[1];
} SYSTEM_HANDLE_INFORMATION_EX, * PSYSTEM_HANDLE_INFORMATION_EX;



PVOID GetCurrentTokenAddress()
{
	HANDLE hToken = 0;
	ULONG_PTR retLength = 0;
	PVOID ret = 0;
	auto hProcess = GetCurrentProcess();
	auto pid = GetCurrentProcessId();
	_NtQuerySystemInformation NtQuerySystemInformation;

	PSYSTEM_HANDLE_INFORMATION_EX ptr = static_cast<PSYSTEM_HANDLE_INFORMATION_EX>(malloc(0x900000));
	NtQuerySystemInformation = reinterpret_cast<_NtQuerySystemInformation>(
		GetProcAddress(GetModuleHandle(L"ntdll.dll"), "NtQuerySystemInformation"));

	OpenProcessToken(hProcess, TOKEN_QUERY, &hToken);
	NtQuerySystemInformation(0x40, ptr, 0x900000, &retLength);

	for (auto i = 0;
		i < ptr->NumberOfHandles; i++) {
		if (ptr->Handles[i].UniqueProcessId == pid && ptr->Handles[i].HandleValue == reinterpret_cast<ULONG_PTR>(hToken)) {
			ret = ptr->Handles[i].Object;
			std::cout << std::hex << ret << std::endl;
		}
	}
	free(ptr);

	return ret;

}